<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Two Editable Panels</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }
    .login-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      width: 100vw;
      background: #021927;
    }
    .login-mic-btn {
      background: transparent;
      border: none;
      border-radius: 0;
      cursor: pointer;
      box-shadow: none;
      transition: none;
    }
    .login-mic-btn:hover {
      opacity: 0.9;
    }
    .login-mic-btn img {
      width: 220px;
      height: auto;
      display: block;
    }
    .main-interface { display: none; }
    .logo-top {
      width: 220px;
      margin: 0 auto 12px auto;
      display: block;
    }
    .logo-top-container {
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin-top: 12px;
      margin-bottom: 0;
    }
    .logo2-top-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      z-index: 100;
      pointer-events: none;
    }
    .logo2-top {
      width: 32px;
      height: 32px;
      margin-top: 12px;
      display: block;
      pointer-events: auto;
      position: fixed;
      left: 50%;
      top: 12px;
      transform: translateX(-50%);
      z-index: 101;
      cursor: grab;
    }
    .top-bar {
      position: relative;
      top: 0;
      left: 0;
      width: 100%;
      display: flex;
      align-items: center;
      padding: 8px 16px 8px 24px;
      min-height: 48px;
      background: transparent;
      z-index: 10;
    }
    .top-bar button,
    .templates-btn-panel,
    .send-btn,
    .login-mic-btn,
    .copy-btn,
    #transcribirBtn {
      width: 100px;
      height: 36px;
      background: #021927;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-left: 6px;
    }
    .top-bar button:hover,
    .templates-btn-panel:hover,
    .send-btn:hover,
    .login-mic-btn:hover,
    .copy-btn:hover,
    #transcribirBtn:hover {
      background: #0d293a;
    }
    .top-bar button[aria-label="Microphone"] svg {
      margin: 0;
      stroke: #fff;
    }
    .container {
      display: flex;
      height: calc(100vh - 72px);
      margin-top: 0;
      gap: 0;
      padding: 0px 20px 20px 20px;
      box-sizing: border-box;
      position: relative;
    }
    .panel {
      display: flex;
      flex-direction: column;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 12px;
      position: relative;
      min-height: 0;
    }
    .panel:first-child {
      width: 50%;
      flex-shrink: 0;
    }
    .panel:last-child {
      flex: 1;
    }
    .divider {
      width: 6px;
      background: #e0e0e0;
      cursor: col-resize;
      border-radius: 4px;
      margin: 0 2px;
      position: relative;
      z-index: 10;
      transition: background 0.2s;
      min-width: 6px;
      height: 100%;
      user-select: none;
      flex-shrink: 0;
    }
    .divider:hover, .divider.active {
      background: #c0c0c0;
    }
    .divider.dragging {
      background: #a0a0a0;
    }
    .arrow-bottom-btn {
      position: absolute;
      bottom: 18px;
      right: 18px;
      width: 40px;
      height: 40px;
      background: #021927;
      color: #fff;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
      transition: background 0.2s;
      z-index: 5;
      font-size: 1.4rem;
      pointer-events: auto;
    }
    .arrow-bottom-btn:hover {
      background: #0d293a;
    }
    .templates-btn-panel-wrapper {
      position: absolute;
      top: 18px;
      right: 18px;
      z-index: 1002;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .templates-btn-panel {
      position: relative;
      width: 85px;
      height: 28px;
      background: #021927;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 1001;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-size: 0.85rem;
      font-weight: 500;
    }
    .templates-btn-panel:hover,
    .templates-btn-panel:focus {
      background: #1a2f3a;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .templates-dropdown {
      position: absolute;
      top: 100%;
      left: 85px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 200px;
    }
    .templates-dropdown-option {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid #f0f0f0;
    }
    .templates-dropdown-option:hover {
      background: #f5f5f5;
    }
    .templates-dropdown-option:last-child {
      border-bottom: none;
    }
    .panel-title {
      font-weight: bold;
      font-size: 1.1rem;
      text-align: center;
      text-transform: uppercase;
      margin-bottom: 6px;
      margin-top: 0;
    }
    .editable {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 12px;
      min-height: 0;
      outline: none;
      background: #fff;
      font-size: 1rem;
      margin-top: 6px;
      overflow-y: auto;
      resize: none;
    }
    .enviar-dropdown {
      display: none;
      position: absolute;
      bottom: 52px;
      right: 0;
      background: #fff;
      color: #021927;
      min-width: 180px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
      border-radius: 6px;
      z-index: 1002;
      font-size: 1rem;
      padding: 8px 0;
      border: 1px solid #021927;
    }
    .enviar-btn-wrapper.show-dropdown .enviar-dropdown {
      display: block;
    }
    .enviar-dropdown-option {
      padding: 10px 24px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s;
    }
    .enviar-dropdown-option:hover {
      background: #f4f4f4;
    }
    .top-bar button.dictating {
      background: #F44336 !important;
      color: #fff !important;
    }
    
    /* Estilos para formularios de login */
    .login-form-container {
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .login-form {
      background: transparent;
      backdrop-filter: none;
      border: none;
      border-radius: 0;
      padding: 30px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    
    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .form-input:focus {
      outline: none;
      border-color: #4CAF50;
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    
    .form-button {
      width: 100%;
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 20px;
    }
    
    .form-button:hover {
      background: #45a049;
    }
    
    .form-button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    
    .form-footer {
      text-align: center;
      font-size: 14px;
    }
    
    .form-footer a:hover {
      text-decoration: underline;
    }
    
    .error-message {
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 14px;
      text-align: center;
    }
    
    .success-message {
      color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 14px;
      text-align: center;
    }
    
    /* Estilos para el bot√≥n de copiar */
    .copy-btn {
      position: relative;
      width: 85px;
      height: 24px;
      background: #021927;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 1003;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .copy-btn:hover {
      background: #0d293a;
      transform: scale(1.05);
    }
    
    .copy-btn:active {
      transform: scale(0.95);
    }
    
    .copy-btn.copied {
      background: #4CAF50;
      animation: pulse 0.3s ease;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="login-page" id="loginPage">
    <!-- Logo arriba -->
    <div style="margin-bottom: 40px; text-align: center;">
      <img src="images/LOGO1.png" alt="Eustakio Logo" style="width: 400px; height: auto; object-fit: contain; display: block; margin: 0 auto;" />
    </div>
    
    <!-- Formulario de Login -->
    <div class="login-form-container" id="loginFormContainer">
      <div class="login-form" id="loginForm">
        <h3 style="color: white; margin-bottom: 20px; text-align: center;">Iniciar Sesi√≥n</h3>
        
        <div class="form-group">
          <input type="text" id="loginEmail" placeholder="Usuario" class="form-input">
        </div>
        
        <div class="form-group">
          <input type="password" id="loginPassword" placeholder="Contrase√±a" class="form-input">
        </div>
        
        <button class="form-button" onclick="iniciarSesion()">Iniciar Sesi√≥n</button>
        
        <div class="form-footer">
          <span style="color: white;">¬øNo tienes cuenta?</span>
          <a href="#" onclick="mostrarRegistro()" style="color: #4CAF50; text-decoration: none; margin-left: 5px;">Crear cuenta</a>
        </div>
      </div>
      
      <!-- Formulario de Registro -->
      <div class="login-form" id="registerForm" style="display: none;">
        <h3 style="color: white; margin-bottom: 20px; text-align: center;">Crear Cuenta</h3>
        
        <div class="form-group">
          <input type="text" id="registerName" placeholder="Nombre completo" class="form-input">
        </div>
        
        <div class="form-group">
          <input type="text" id="registerEmail" placeholder="Usuario" class="form-input">
        </div>
        
        <div class="form-group">
          <input type="password" id="registerPassword" placeholder="Contrase√±a" class="form-input">
        </div>
        
        <div class="form-group">
          <input type="password" id="registerConfirmPassword" placeholder="Confirmar contrase√±a" class="form-input">
        </div>
        
        <button class="form-button" onclick="crearCuenta()">Crear Cuenta</button>
        
        <div class="form-footer">
          <span style="color: white;">¬øYa tienes cuenta?</span>
          <a href="#" onclick="mostrarLogin()" style="color: #4CAF50; text-decoration: none; margin-left: 5px;">Iniciar sesi√≥n</a>
        </div>
      </div>
    </div>
  </div>
  <div class="main-interface" id="mainInterface">
    <div class="top-bar">
      <button>IMPORTAR</button>
      <button id="micBtn" aria-label="Microphone" style="margin-left:6px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><rect x="9" y="2" width="6" height="12" rx="3"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/></svg>
      </button>
      <button id="transcribirBtn" style="margin-left:6px;">TRANSCRIBIR</button>
      <input type="file" id="audioFileInput" accept="audio/*" style="display: none;" onchange="transcribirAudio()">
      <button class="copy-btn" id="copyBtn" title="Copiar contenido al portapapeles" onclick="copiarContenido()" style="margin-left:6px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
      <div style="flex: 1;"></div>
      <button class="templates-btn-panel" onclick="toggleTemplatesDropdown()">PLANTILLAS</button>
      
      <!-- Dropdown de plantillas -->
      <div class="templates-dropdown" id="templatesDropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; min-width: 200px;">
        <div class="templates-dropdown-option">GENERAL</div>
        <div class="templates-dropdown-option">CARDIOVASCULAR</div>
        <div class="templates-dropdown-option">SALUD MENTAL</div>
        <div class="templates-dropdown-option">EPICRISIS</div>
        <div class="templates-dropdown-option">CERTIFICADO</div>
        <div class="templates-dropdown-option" style="border-top: 1px solid #ccc; margin-top: 5px; padding-top: 5px;">CREAR NUEVA PLANTILLA</div>
      </div>
    </div>
    <div class="container" id="splitContainer">
      <div class="panel" id="panel1">
        <div class="panel-title">PANEL 1</div>
        <div class="editable" contenteditable="true" id="editable1">Edit this text...</div>
        <button class="arrow-bottom-btn" title="Completar plantilla" onclick="completarPlantillaConOpenAI()">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        </button>
      </div>
      <div class="divider" id="divider">
      </div>
      <div class="panel" id="panel2">
        <div class="panel-title">PANEL 2</div>
        <div class="editable" contenteditable="true" id="editable2">Edit this text...</div>
      </div>
    </div>
    <div class="enviar-btn-wrapper" style="position: fixed; bottom: 12px; right: 28px; z-index: 10;">
      <button class="send-btn" id="enviarBtn">GUARDAR PDF</button>
      <div class="enviar-dropdown">
        <div class="enviar-dropdown-option">GUARDAR COMO PDF</div>
        <div class="enviar-dropdown-option">IMPRIMIR</div>
      </div>
    </div>
  </div>
  
  <!-- Modal para crear nueva plantilla -->
  <div id="crearPlantillaModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    justify-content: center;
    align-items: center;
  ">
    <div style="
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    ">
      <h3 style="margin-top: 0; color: #021927;">Crear Nueva Plantilla</h3>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Nombre de la plantilla:</label>
        <input type="text" id="nombrePlantilla" placeholder="Ej: NEUROLOG√çA, PEDIATR√çA, etc." style="
          width: 100%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
          font-size: 14px;
        ">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Contenido de la plantilla:</label>
        <textarea id="contenidoPlantilla" placeholder="Escribe aqu√≠ el contenido de tu plantilla..." style="
          width: 100%;
          height: 300px;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
          font-size: 14px;
          font-family: Arial, sans-serif;
          resize: vertical;
        "></textarea>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          üí° Tip: Usa <u>texto</u> para subrayar, <br> para saltos de l√≠nea, y [texto] para campos a completar
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Plantillas de ejemplo:</label>
        <select id="plantillaEjemplo" style="
          width: 100%;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
          font-size: 14px;
        ">
          <option value="">Seleccionar plantilla de ejemplo...</option>
          <option value="general">Plantilla General</option>
          <option value="epicrisis">Plantilla Epicrisis</option>
          <option value="cardiovascular">Plantilla Cardiovascular</option>
          <option value="mental">Plantilla Salud Mental</option>
        </select>
      </div>
      
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="cerrarModalCrearPlantilla()" style="
          background: #ccc;
          color: #333;
          border: none;
          padding: 12px 24px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
        ">Cancelar</button>
        <button onclick="guardarNuevaPlantilla()" style="
          background: #021927;
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
        ">Guardar Plantilla</button>
      </div>
    </div>
  </div>
  
  <script>
    // Sistema de autenticaci√≥n
    let usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
    let usuarioActual = JSON.parse(localStorage.getItem('usuarioActual') || 'null');
    
    // Crear usuario de prueba si no existe
    if (!usuarios.find(u => u.email === 'test')) {
      const usuarioTest = {
        id: 1,
        nombre: 'Usuario Test',
        email: 'test',
        password: 'test',
        fechaCreacion: new Date().toISOString()
      };
      usuarios.push(usuarioTest);
      localStorage.setItem('usuarios', JSON.stringify(usuarios));
      console.log('‚úÖ Usuario de prueba creado: test / test');
    } else {
      console.log('‚ÑπÔ∏è Usuario de prueba ya existe: test / test');
    }
    
    // Mostrar usuarios disponibles en consola para debugging
    console.log('üë• Usuarios disponibles:', usuarios.map(u => ({ email: u.email, password: u.password })));
    
    // Verificar si ya hay una sesi√≥n activa
    if (usuarioActual) {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainInterface').style.display = 'block';
    }
    
    function mostrarMensaje(formId, mensaje, tipo) {
      const form = document.getElementById(formId);
      const mensajeExistente = form.querySelector('.error-message, .success-message');
      if (mensajeExistente) {
        mensajeExistente.remove();
      }
      
      const mensajeElement = document.createElement('div');
      mensajeElement.className = tipo === 'error' ? 'error-message' : 'success-message';
      mensajeElement.textContent = mensaje;
      
      form.insertBefore(mensajeElement, form.firstChild);
      
      setTimeout(() => {
        mensajeElement.remove();
      }, 5000);
    }
    
    function validarEmail(email) {
      // Ya no necesitamos validar email, solo verificar que no est√© vac√≠o
      return email.trim().length > 0;
    }
    
    function validarPassword(password) {
      return password.length >= 3;
    }
    
    function mostrarRegistro() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }
    
    function mostrarLogin() {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }
    
    function crearCuenta() {
      const nombre = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;
      
      // Validaciones
      if (!nombre) {
        mostrarMensaje('registerForm', 'Por favor ingresa tu nombre completo', 'error');
        return;
      }
      
      if (!validarEmail(email)) {
        mostrarMensaje('registerForm', 'Por favor ingresa un nombre de usuario', 'error');
        return;
      }
      
      if (!validarPassword(password)) {
        mostrarMensaje('registerForm', 'La contrase√±a debe tener al menos 3 caracteres', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        mostrarMensaje('registerForm', 'Las contrase√±as no coinciden', 'error');
        return;
      }
      
      // Verificar si el usuario ya existe
      const usuarioExistente = usuarios.find(u => u.email === email);
      if (usuarioExistente) {
        mostrarMensaje('registerForm', 'Ya existe una cuenta con este nombre de usuario', 'error');
        return;
      }
      
      // Crear nuevo usuario
      const nuevoUsuario = {
        id: Date.now(),
        nombre: nombre,
        email: email,
        password: password, // En producci√≥n, esto deber√≠a estar hasheado
        fechaCreacion: new Date().toISOString()
      };
      
      usuarios.push(nuevoUsuario);
      localStorage.setItem('usuarios', JSON.stringify(usuarios));
      
      mostrarMensaje('registerForm', 'Cuenta creada exitosamente. Ya puedes iniciar sesi√≥n.', 'success');
      
      // Limpiar formulario
      document.getElementById('registerName').value = '';
      document.getElementById('registerEmail').value = '';
      document.getElementById('registerPassword').value = '';
      document.getElementById('registerConfirmPassword').value = '';
      
      // Cambiar a formulario de login despu√©s de 2 segundos
      setTimeout(() => {
        mostrarLogin();
      }, 2000);
    }
    
    function iniciarSesion() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      // Validaciones
      if (!email || !password) {
        mostrarMensaje('loginForm', 'Por favor completa todos los campos', 'error');
        return;
      }
      
      // Buscar usuario
      const usuario = usuarios.find(u => u.email === email && u.password === password);
      
      if (!usuario) {
        mostrarMensaje('loginForm', 'Nombre de usuario o contrase√±a incorrectos', 'error');
        return;
      }
      
      // Iniciar sesi√≥n
      usuarioActual = {
        id: usuario.id,
        nombre: usuario.nombre,
        email: usuario.email
      };
      
      localStorage.setItem('usuarioActual', JSON.stringify(usuarioActual));
      
      // Mostrar interfaz principal
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainInterface').style.display = 'block';
      
      // Mostrar nombre del usuario en la interfaz
      mostrarNombreUsuario();
    }
    
    function cerrarSesion() {
      localStorage.removeItem('usuarioActual');
      usuarioActual = null;
      
      document.getElementById('mainInterface').style.display = 'none';
      document.getElementById('loginPage').style.display = 'flex';
      
      // Limpiar formularios
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    }
    
    function mostrarNombreUsuario() {
      if (usuarioActual) {
        // Agregar nombre del usuario en la barra superior
        const topBar = document.querySelector('.top-bar');
        
        // Primero, remover cualquier elemento de nombre de usuario existente
        const existingNombreUsuario = topBar.querySelector('.nombre-usuario');
        if (existingNombreUsuario) {
          existingNombreUsuario.remove();
        }
        
        const nombreUsuario = document.createElement('div');
        nombreUsuario.className = 'nombre-usuario'; // Agregar clase para identificarlo
        nombreUsuario.style.cssText = `
          margin-left: auto;
          color: #021927;
          font-weight: bold;
          font-size: 14px;
          display: flex;
          align-items: center;
          gap: 10px;
        `;
        nombreUsuario.innerHTML = `
          <span>üë§ ${usuarioActual.nombre}</span>
          <button onclick="cerrarSesion()" style="
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
          ">Cerrar Sesi√≥n</button>
        `;
        topBar.appendChild(nombreUsuario);
        
        // Cargar plantillas personalizadas del usuario
        cargarPlantillasPersonalizadas();
      }
    }
    
    // Mostrar nombre del usuario si ya est√° logueado
    if (usuarioActual) {
      mostrarNombreUsuario();
    }
    
    // Event listeners para formularios
    document.addEventListener('DOMContentLoaded', function() {
      // Login con Enter
      document.getElementById('loginPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          iniciarSesion();
        }
      });
      
      // Registro con Enter
      document.getElementById('registerConfirmPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          crearCuenta();
        }
      });
      
      // Login con Enter en email
      document.getElementById('loginEmail').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('loginPassword').focus();
        }
      });
      
      // Registro con Enter en campos
      document.getElementById('registerName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('registerEmail').focus();
        }
      });
      
      document.getElementById('registerEmail').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('registerPassword').focus();
        }
      });
      
      document.getElementById('registerPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('registerConfirmPassword').focus();
        }
      });
    });
    
    document.getElementById('loginMicBtn').onclick = function() {
      // Ya no necesitamos esta funci√≥n para el logo, pero la mantenemos por compatibilidad
    };
    
    // Arrow button logic
    document.getElementById('arrowRightBtn').onclick = function() {
      const leftContent = document.getElementById('editable1').innerHTML;
      document.getElementById('editable2').innerHTML = leftContent;
    };
    
    // Very simple resizer - bypass all interference
    const divider = document.getElementById('divider');
    const panel1 = document.getElementById('panel1');
    const panel2 = document.getElementById('panel2');
    let isDragging = false;
    let startX = 0;
    let startWidth = 0;
    
    // Force divider to be clickable
    divider.style.pointerEvents = 'auto';
    divider.style.position = 'relative';
    divider.style.zIndex = '9999';
    
    // Simple mouse events
    divider.onmousedown = function(e) {
      console.log('MOUSE DOWN ON DIVIDER');
      isDragging = true;
      startX = e.clientX;
      startWidth = panel1.offsetWidth;
      
      divider.style.background = '#a0a0a0';
      document.body.style.cursor = 'col-resize';
      
      e.preventDefault();
      e.stopPropagation();
      return false;
    };
    
    document.onmousemove = function(e) {
      if (!isDragging) return;
      
      console.log('DRAGGING...', e.clientX);
      const deltaX = e.clientX - startX;
      const newWidth = startWidth + deltaX;
      
      // Simple bounds
      const minWidth = 200;
      const maxWidth = window.innerWidth - 400;
      const clampedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
      
      console.log('Setting width to:', clampedWidth);
      panel1.style.width = clampedWidth + 'px';
      panel1.style.flex = 'none';
    };
    
    document.onmouseup = function() {
      if (isDragging) {
        console.log('MOUSE UP - STOPPING');
        isDragging = false;
        divider.style.background = '#e0e0e0';
        document.body.style.cursor = '';
      }
    };
    
    // Prevent any interference
    divider.addEventListener('click', function(e) {
      e.stopPropagation();
    });
    
    divider.addEventListener('selectstart', function(e) {
      e.preventDefault();
    });
    
    // Dropdown toggle logic for TEMPLATES button (robust)
    (function() {
      const templatesBtn = document.querySelector('.templates-btn-panel');
      const templatesDropdown = document.getElementById('templatesDropdown');
      
      // Toggle dropdown on button click
      templatesBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        templatesDropdown.style.display = templatesDropdown.style.display === 'none' ? 'block' : 'none';
      });
      
      // Close dropdown when clicking an option
      templatesDropdown.addEventListener('click', function(e) {
        e.stopPropagation();
        templatesDropdown.style.display = 'none';
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!templatesBtn.contains(e.target) && !templatesDropdown.contains(e.target)) {
          templatesDropdown.style.display = 'none';
        }
      });
    })();
    // Plantillas templates
    const plantillaTemplates = {
      GENERAL: `<u>Identificaci√≥n de paciente:</u><br> Nombre:<br> Edad:<br><br><u>Motivo de consulta:</u><br><br><u>Anmanesis pr√≥xima</u><br><br><u>Anamnesis remota</u><br>AM:<br>AQX:<br>MEDS:<br>ALERGIAS:<br>H√ÅBITOS:<br>GO:<br>AF:<br><br><u>Examen f√≠sico</u><br><br><u>Diagn√≥sticos</u><br><br><u>Plan</u>`,
      CARDIOVASCULAR: '',
      'SALUD MENTAL': '',
      EPICRISIS: `EPICRISIS [SERVICIO]<br><br>Fecha: [dd/mm/aaaa]<br>Nombre: [Nombre completo]<br>RUT: [RUT completo]<br>Edad: [a√±os]<br>FI HSR: [dd/mm]<br>FI [SERVICIO]: [dd/mm]<br><br><u>ANAMNESIS REMOTA</u><br>M√©dicos: [Enfermedades cr√≥nicas]<br>F√°rmacos: [Lista de medicamentos habituales]<br>Quir√∫rgicos: [Cirug√≠as previas]<br>Alergias: [S√≠ / No]<br>H√°bitos: [Tabaco, alcohol, drogas]<br>Hospitalizaciones recientes: [S√≠ / No]<br>Sociales: [Red de apoyo, nivel funcional, vivienda]<br><br><u>ANAMNESIS PR√ìXIMA</u><br>[Relato del motivo de consulta y evoluci√≥n reciente con foco en el ingreso hospitalario, hallazgos relevantes y contexto del cuadro agudo.]<br><br><u>EX√ÅMENES DE LABORATORIO AL INGRESO</u><br>[Fecha]: [Lista de ex√°menes relevantes con sus resultados]<br><br><u>IM√ÅGENES DE INGRESO</u><br>[Fecha y tipo de imagen]: [Descripci√≥n relevante de hallazgos]<br><br><u>DIAGN√ìSTICOS DE INGRESO</u><br>[Dx 1]<br>[Dx 2]<br>[Dx 3]<br>(...)<br><br><u>EVOLUCI√ìN DURANTE LA HOSPITALIZACI√ìN</u><br>[ESPECIALIDAD 1]:<br>[Resumen de evoluci√≥n, decisiones cl√≠nicas, tratamientos realizados]<br><br>[ESPECIALIDAD 2]:<br>[Lo mismo, si aplica]<br><br>[ESPECIALIDAD 3]:<br>[Etc.]<br><br>(...)<br><br><u>DIAGN√ìSTICOS DE EGRESO</u><br>[Dx principal]<br>[Dx secundarios]<br>[Condiciones funcionales o sociales si aplica]<br><br><u>INDICACIONES AL ALTA</u><br><u>CUIDADOS GENERALES:</u><br>[Ej.: dieta, movilidad, restricciones, cuidados en domicilio]<br><br><u>MEDICAMENTOS:</u><br><br>[Nombre, dosis, v√≠a, frecuencia, duraci√≥n]<br><br><u>CONTROLES:</u><br><br>[Especialidad / programa / lugar]<br>[GES firmado s√≠/no]<br>[Indicaciones de urgencia]`,
      CERTIFICADO: ''
    };
    document.querySelectorAll('.templates-dropdown-option').forEach(option => {
      option.addEventListener('click', function(e) {
        if (this.textContent.trim() === 'CREAR NUEVA PLANTILLA') {
          mostrarModalCrearPlantilla();
        } else {
          // Primero intentar cargar plantilla personalizada del usuario
          const plantillasUsuario = obtenerPlantillasUsuario();
          let html = plantillasUsuario[this.textContent.trim()];
          
          // Si no existe plantilla personalizada, usar predefinida
          if (!html) {
            const plantillasPredefinidas = {
              'GENERAL': `<u>Identificaci√≥n de paciente:</u><br> Nombre:<br> Edad:<br><br><u>Motivo de consulta:</u><br><br><u>Anmanesis pr√≥xima</u><br><br><u>Anamnesis remota</u><br>AM:<br>AQX:<br>MEDS:<br>ALERGIAS:<br>H√ÅBITOS:<br>GO:<br>AF:<br><br><u>Examen f√≠sico</u><br><br><u>Diagn√≥sticos</u><br><br><u>Plan</u>`,
              'CARDIOVASCULAR': '<h2>NOTA CARDIOVASCULAR</h2><p><strong>Fecha:</strong> [Fecha]</p><p><strong>Paciente:</strong> [Nombre del paciente]</p><p><strong>S√≠ntomas:</strong> [Dolor tor√°cico, disnea, etc.]</p><p><strong>Exploraci√≥n cardiovascular:</strong> [Frecuencia card√≠aca, presi√≥n arterial, etc.]</p><p><strong>Electrocardiograma:</strong> [Hallazgos ECG]</p><p><strong>Diagn√≥stico:</strong> [Diagn√≥stico cardiovascular]</p><p><strong>Tratamiento:</strong> [Medicaci√≥n, intervenciones]</p><p><strong>Recomendaciones:</strong> [Cambios en estilo de vida, seguimiento]</p>',
              'SALUD MENTAL': '<h2>NOTA DE SALUD MENTAL</h2><p><strong>Fecha:</strong> [Fecha]</p><p><strong>Paciente:</strong> [Nombre del paciente]</p><p><strong>Estado mental:</strong> [Aspecto, comportamiento, estado de √°nimo]</p><p><strong>S√≠ntomas psiqui√°tricos:</strong> [Descripci√≥n de s√≠ntomas]</p><p><strong>Evaluaci√≥n de riesgo:</strong> [Ideaci√≥n suicida, homicida, etc.]</p><p><strong>Diagn√≥stico:</strong> [Diagn√≥stico psiqui√°trico]</p><p><strong>Plan de tratamiento:</strong> [Medicaci√≥n, psicoterapia, etc.]</p><p><strong>Seguimiento:</strong> [Pr√≥xima cita, recomendaciones]</p>',
              'EPICRISIS': `EPICRISIS [SERVICIO]<br><br>Fecha: [dd/mm/aaaa]<br>Nombre: [Nombre completo]<br>RUT: [RUT completo]<br>Edad: [a√±os]<br>FI HSR: [dd/mm]<br>FI [SERVICIO]: [dd/mm]<br><br><u>ANAMNESIS REMOTA</u><br>M√©dicos: [Enfermedades cr√≥nicas]<br>F√°rmacos: [Lista de medicamentos habituales]<br>Quir√∫rgicos: [Cirug√≠as previas]<br>Alergias: [S√≠ / No]<br>H√°bitos: [Tabaco, alcohol, drogas]<br>Hospitalizaciones recientes: [S√≠ / No]<br>Sociales: [Red de apoyo, nivel funcional, vivienda]<br><br><u>ANAMNESIS PR√ìXIMA</u><br>[Relato del motivo de consulta y evoluci√≥n reciente con foco en el ingreso hospitalario, hallazgos relevantes y contexto del cuadro agudo.]<br><br><u>EX√ÅMENES DE LABORATORIO AL INGRESO</u><br>[Fecha]: [Lista de ex√°menes relevantes con sus resultados]<br><br><u>IM√ÅGENES DE INGRESO</u><br>[Fecha y tipo de imagen]: [Descripci√≥n relevante de hallazgos]<br><br><u>DIAGN√ìSTICOS DE INGRESO</u><br>[Dx 1]<br>[Dx 2]<br>[Dx 3]<br>(...)<br><br><u>EVOLUCI√ìN DURANTE LA HOSPITALIZACI√ìN</u><br>[ESPECIALIDAD 1]:<br>[Resumen de evoluci√≥n, decisiones cl√≠nicas, tratamientos realizados]<br><br>[ESPECIALIDAD 2]:<br>[Lo mismo, si aplica]<br><br>[ESPECIALIDAD 3]:<br>[Etc.]<br><br>(...)<br><br><u>DIAGN√ìSTICOS DE EGRESO</u><br>[Dx principal]<br>[Dx secundarios]<br>[Condiciones funcionales o sociales si aplica]<br><br><u>INDICACIONES AL ALTA</u><br><u>CUIDADOS GENERALES:</u><br>[Ej.: dieta, movilidad, restricciones, cuidados en domicilio]<br><br><u>MEDICAMENTOS:</u><br><br>[Nombre, dosis, v√≠a, frecuencia, duraci√≥n]<br><br><u>CONTROLES:</u><br><br>[Especialidad / programa / lugar]<br>[GES firmado s√≠/no]<br>[Indicaciones de urgencia]`,
              'CERTIFICADO': '<h2>CERTIFICADO M√âDICO</h2><p><strong>Fecha:</strong> [Fecha]</p><p><strong>Paciente:</strong> [Nombre completo]</p><p><strong>DNI:</strong> [N√∫mero de documento]</p><p><strong>Certifico que:</strong> [Descripci√≥n de la condici√≥n m√©dica]</p><p><strong>Diagn√≥stico:</strong> [Diagn√≥stico m√©dico]</p><p><strong>Recomendaciones:</strong> [Recomendaciones m√©dicas]</p><p><strong>Vigencia:</strong> [Per√≠odo de validez]</p><p><strong>Firma del m√©dico:</strong> [Nombre y firma]</p><p><strong>N√∫mero de colegiado:</strong> [N√∫mero de registro]</p>'
            };
            html = plantillasPredefinidas[this.textContent.trim()] || '';
          }
          
          document.getElementById('editable2').innerHTML = html;
        }
      });
    });
    // Microphone dictation logic
    const micBtn = document.getElementById('micBtn');
    console.log('Microphone button found:', !!micBtn);
    let recognizing = false;
    let recognition;
    // Detect Safari
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if ((window.SpeechRecognition || window.webkitSpeechRecognition) && !isSafari) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'es-ES';
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.onresult = function(event) {
        let transcript = '';
        for (let i = 0; i < event.results.length; ++i) {
          transcript += event.results[i][0].transcript;
          if (!event.results[i].isFinal) transcript += ' ';
        }
        document.getElementById('editable1').innerText = transcript;
      };
      recognition.onend = function() {
        recognizing = false;
        micBtn.classList.remove('dictating');
      };
      micBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (recognizing) {
          recognition.stop();
          recognizing = false;
          micBtn.classList.remove('dictating');
        } else {
          recognition.start();
          recognizing = true;
          micBtn.classList.add('dictating');
        }
      });
    } else {
      micBtn.addEventListener('click', function() {
        alert('La funci√≥n de dictado solo est√° disponible en navegadores Chrome, Edge, Brave o similares. Safari no es compatible.');
      });
    }
    // ENVIAR dropdown logic
    const enviarWrapper = document.querySelector('.enviar-btn-wrapper');
    const enviarBtn = document.getElementById('enviarBtn');
    const enviarDropdown = enviarWrapper.querySelector('.enviar-dropdown');
    enviarBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      generarPDF();
    });
    enviarDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
      enviarWrapper.classList.remove('show-dropdown');
    });
    document.addEventListener('click', function(e) {
      if (!enviarWrapper.contains(e.target)) {
        enviarWrapper.classList.remove('show-dropdown');
      }
    });
    async function generarPDF() {
      try {
        // Mostrar indicador de carga
        enviarBtn.textContent = 'üîÑ Generando PDF...';
        enviarBtn.disabled = true;
        
        // Obtener contenido de ambos paneles
        const contenidoPanel1 = document.getElementById('editable1').innerHTML;
        const contenidoPanel2 = document.getElementById('editable2').innerHTML;
        
        // Crear contenido para el PDF
        const contenidoPDF = `
          <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #021927; margin: 0;">Eustakio Interface</h1>
              <p style="color: #666; margin: 5px 0;">Documento generado el ${new Date().toLocaleDateString('es-ES')}</p>
            </div>
            
            <div style="display: flex; gap: 20px; margin-bottom: 30px;">
              <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                <h3 style="color: #021927; margin-top: 0; border-bottom: 2px solid #021927; padding-bottom: 5px;">Panel 1 - Notas y Transcripci√≥n</h3>
                <div style="line-height: 1.6;">${contenidoPanel1}</div>
              </div>
              
              <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                <h3 style="color: #021927; margin-top: 0; border-bottom: 2px solid #021927; padding-bottom: 5px;">Panel 2 - Plantilla Completada</h3>
                <div style="line-height: 1.6;">${contenidoPanel2}</div>
              </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px;">
              <p>Documento generado autom√°ticamente por Eustakio Interface</p>
            </div>
          </div>
        `;
        
        // Crear elemento temporal para renderizar el contenido
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = contenidoPDF;
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        tempDiv.style.top = '0';
        tempDiv.style.width = '800px';
        document.body.appendChild(tempDiv);
        
        // Generar PDF usando html2canvas y jsPDF
        const canvas = await html2canvas(tempDiv, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff'
        });
        
        // Remover elemento temporal
        document.body.removeChild(tempDiv);
        
        // Crear PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 295; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        // Agregar imagen al PDF
        pdf.addImage(canvas, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Agregar p√°ginas adicionales si es necesario
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(canvas, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        // Generar nombre del archivo
        const fecha = new Date().toISOString().slice(0, 10);
        const hora = new Date().toLocaleTimeString('es-ES', { hour12: false }).replace(/:/g, '-');
        const nombreArchivo = `eustakio_${fecha}_${hora}.pdf`;
        
        // Descargar PDF
        pdf.save(nombreArchivo);
        
        // Restaurar bot√≥n
        enviarBtn.textContent = 'GUARDAR PDF';
        enviarBtn.disabled = false;
        
        // Mostrar mensaje de √©xito
        mostrarMensajeExito('PDF generado exitosamente');
        
      } catch (error) {
        console.error('Error al generar PDF:', error);
        
        // Restaurar bot√≥n
        enviarBtn.textContent = 'GUARDAR PDF';
        enviarBtn.disabled = false;
        
        alert('Error al generar el PDF: ' + error.message);
      }
    }
    
    function mostrarMensajeExito(mensaje) {
      const notificacion = document.createElement('div');
      notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 4px;
        z-index: 10002;
        animation: slideIn 0.3s ease-out;
        font-weight: bold;
      `;
      notificacion.textContent = mensaje;
      document.body.appendChild(notificacion);
      
      // Remover despu√©s de 3 segundos
      setTimeout(() => {
        notificacion.remove();
      }, 3000);
    }
    
    // Funciones para crear nueva plantilla
    function mostrarModalCrearPlantilla() {
      document.getElementById('crearPlantillaModal').style.display = 'flex';
    }
    
    function cerrarModalCrearPlantilla() {
      document.getElementById('crearPlantillaModal').style.display = 'none';
      document.getElementById('nombrePlantilla').value = '';
      document.getElementById('contenidoPlantilla').value = '';
      document.getElementById('plantillaEjemplo').value = '';
    }
    
    function cargarPlantillaEjemplo() {
      const select = document.getElementById('plantillaEjemplo');
      const textarea = document.getElementById('contenidoPlantilla');
      
      const ejemplos = {
        'general': `<u>Identificaci√≥n de paciente:</u><br> Nombre:<br> Edad:<br><br><u>Motivo de consulta:</u><br><br><u>Anmanesis pr√≥xima</u><br><br><u>Anamnesis remota</u><br>AM:<br>AQX:<br>MEDS:<br>ALERGIAS:<br>H√ÅBITOS:<br>GO:<br>AF:<br><br><u>Examen f√≠sico</u><br><br><u>Diagn√≥sticos</u><br><br><u>Plan</u>`,
        'epicrisis': `EPICRISIS [SERVICIO]<br><br>Fecha: [dd/mm/aaaa]<br>Nombre: [Nombre completo]<br>RUT: [RUT completo]<br>Edad: [a√±os]<br>FI HSR: [dd/mm]<br>FI [SERVICIO]: [dd/mm]<br><br><u>ANAMNESIS REMOTA</u><br>M√©dicos: [Enfermedades cr√≥nicas]<br>F√°rmacos: [Lista de medicamentos habituales]<br>Quir√∫rgicos: [Cirug√≠as previas]<br>Alergias: [S√≠ / No]<br>H√°bitos: [Tabaco, alcohol, drogas]<br>Hospitalizaciones recientes: [S√≠ / No]<br>Sociales: [Red de apoyo, nivel funcional, vivienda]<br><br><u>ANAMNESIS PR√ìXIMA</u><br>[Relato del motivo de consulta y evoluci√≥n reciente con foco en el ingreso hospitalario, hallazgos relevantes y contexto del cuadro agudo.]<br><br><u>EX√ÅMENES DE LABORATORIO AL INGRESO</u><br>[Fecha]: [Lista de ex√°menes relevantes con sus resultados]<br><br><u>IM√ÅGENES DE INGRESO</u><br>[Fecha y tipo de imagen]: [Descripci√≥n relevante de hallazgos]<br><br><u>DIAGN√ìSTICOS DE INGRESO</u><br>[Dx 1]<br>[Dx 2]<br>[Dx 3]<br>(...)<br><br><u>EVOLUCI√ìN DURANTE LA HOSPITALIZACI√ìN</u><br>[ESPECIALIDAD 1]:<br>[Resumen de evoluci√≥n, decisiones cl√≠nicas, tratamientos realizados]<br><br>[ESPECIALIDAD 2]:<br>[Lo mismo, si aplica]<br><br>[ESPECIALIDAD 3]:<br>[Etc.]<br><br>(...)<br><br><u>DIAGN√ìSTICOS DE EGRESO</u><br>[Dx principal]<br>[Dx secundarios]<br>[Condiciones funcionales o sociales si aplica]<br><br><u>INDICACIONES AL ALTA</u><br><u>CUIDADOS GENERALES:</u><br>[Ej.: dieta, movilidad, restricciones, cuidados en domicilio]<br><br><u>MEDICAMENTOS:</u><br><br>[Nombre, dosis, v√≠a, frecuencia, duraci√≥n]<br><br><u>CONTROLES:</u><br><br>[Especialidad / programa / lugar]<br>[GES firmado s√≠/no]<br>[Indicaciones de urgencia]`,
        'cardiovascular': '<h2>NOTA CARDIOVASCULAR</h2><p><strong>Fecha:</strong> [Fecha]</p><p><strong>Paciente:</strong> [Nombre del paciente]</p><p><strong>S√≠ntomas:</strong> [Dolor tor√°cico, disnea, etc.]</p><p><strong>Exploraci√≥n cardiovascular:</strong> [Frecuencia card√≠aca, presi√≥n arterial, etc.]</p><p><strong>Electrocardiograma:</strong> [Hallazgos ECG]</p><p><strong>Diagn√≥stico:</strong> [Diagn√≥stico cardiovascular]</p><p><strong>Tratamiento:</strong> [Medicaci√≥n, intervenciones]</p><p><strong>Recomendaciones:</strong> [Cambios en estilo de vida, seguimiento]</p>',
        'mental': '<h2>NOTA DE SALUD MENTAL</h2><p><strong>Fecha:</strong> [Fecha]</p><p><strong>Paciente:</strong> [Nombre del paciente]</p><p><strong>Estado mental:</strong> [Aspecto, comportamiento, estado de √°nimo]</p><p><strong>S√≠ntomas psiqui√°tricos:</strong> [Descripci√≥n de s√≠ntomas]</p><p><strong>Evaluaci√≥n de riesgo:</strong> [Ideaci√≥n suicida, homicida, etc.]</p><p><strong>Diagn√≥stico:</strong> [Diagn√≥stico psiqui√°trico]</p><p><strong>Plan de tratamiento:</strong> [Medicaci√≥n, psicoterapia, etc.]</p><p><strong>Seguimiento:</strong> [Pr√≥xima cita, recomendaciones]</p>'
      };
      
      if (select.value && ejemplos[select.value]) {
        textarea.value = ejemplos[select.value];
      }
    }
    
    function guardarNuevaPlantilla() {
      const nombre = document.getElementById('nombrePlantilla').value.trim();
      const contenido = document.getElementById('contenidoPlantilla').value.trim();
      
      if (!nombre) {
        alert('Por favor ingresa un nombre para la plantilla');
        return;
      }
      
      if (!contenido) {
        alert('Por favor ingresa el contenido de la plantilla');
        return;
      }
      
      // Obtener plantillas actuales del usuario
      const plantillasActuales = obtenerPlantillasUsuario();
      
      // Agregar la nueva plantilla
      plantillasActuales[nombre] = contenido;
      
      // Guardar plantillas del usuario
      guardarPlantillasUsuario(plantillasActuales);
      
      // Crear nueva opci√≥n en el dropdown
      const dropdown = document.querySelector('.templates-dropdown');
      const nuevaOpcion = document.createElement('div');
      nuevaOpcion.className = 'templates-dropdown-option';
      nuevaOpcion.textContent = nombre;
      nuevaOpcion.addEventListener('click', function(e) {
        const plantillas = obtenerPlantillasUsuario();
        const html = plantillas[this.textContent.trim()] || '';
        document.getElementById('editable2').innerHTML = html;
      });
      
      // Insertar antes de "CREAR NUEVA PLANTILLA"
      const crearOpcion = dropdown.querySelector('.templates-dropdown-option:last-child');
      dropdown.insertBefore(nuevaOpcion, crearOpcion);
      
      // Cerrar modal y mostrar mensaje de √©xito
      cerrarModalCrearPlantilla();
      alert(`Plantilla "${nombre}" creada exitosamente para tu usuario`);
    }
    
    // Cargar plantillas personalizadas al iniciar
    function cargarPlantillasPersonalizadas() {
      if (!usuarioActual) return;
      
      const plantillasUsuario = obtenerPlantillasUsuario();
      
      // Recrear opciones del dropdown
      const dropdown = document.getElementById('templatesDropdown');
      const crearOpcion = dropdown.querySelector('.templates-dropdown-option:last-child');
      
      // Remover opciones existentes excepto "CREAR NUEVA PLANTILLA"
      const opcionesExistentes = dropdown.querySelectorAll('.templates-dropdown-option:not(:last-child)');
      opcionesExistentes.forEach(opcion => opcion.remove());
      
      // Agregar opciones de plantillas del usuario
      Object.keys(plantillasUsuario).forEach(nombre => {
        if (nombre !== 'CREAR NUEVA PLANTILLA') {
          const nuevaOpcion = document.createElement('div');
          nuevaOpcion.className = 'templates-dropdown-option';
          nuevaOpcion.textContent = nombre;
          nuevaOpcion.addEventListener('click', function(e) {
            const plantillas = obtenerPlantillasUsuario();
            const html = plantillas[this.textContent.trim()] || '';
            document.getElementById('editable2').innerHTML = html;
          });
          dropdown.insertBefore(nuevaOpcion, crearOpcion);
        }
      });
    }
    
    // Event listeners para el modal
    document.getElementById('plantillaEjemplo').addEventListener('change', cargarPlantillaEjemplo);
    
    // Cerrar modal al hacer clic fuera
    document.getElementById('crearPlantillaModal').addEventListener('click', function(e) {
      if (e.target === this) {
        cerrarModalCrearPlantilla();
      }
    });
    
    // Cargar plantillas personalizadas al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', cargarPlantillasPersonalizadas);
    
    // Funci√≥n para obtener plantillas del usuario actual
    function obtenerPlantillasUsuario() {
      if (!usuarioActual) return plantillaTemplates;
      
      const plantillasUsuario = JSON.parse(localStorage.getItem(`plantillas_${usuarioActual.id}`) || '{}');
      return { ...plantillaTemplates, ...plantillasUsuario };
    }
    
    // Funci√≥n para guardar plantillas del usuario actual
    function guardarPlantillasUsuario(plantillas) {
      if (!usuarioActual) return;
      
      const plantillasUsuario = {};
      Object.keys(plantillas).forEach(key => {
        if (!plantillaTemplates[key]) { // Solo guardar plantillas personalizadas
          plantillasUsuario[key] = plantillas[key];
        }
      });
      
      localStorage.setItem(`plantillas_${usuarioActual.id}`, JSON.stringify(plantillasUsuario));
    }
    
    async function completarPlantillaConOpenAI() {
      if (transcripcionIntegrator) {
        transcripcionIntegrator.completarPlantilla();
      } else {
        alert('M√≥dulo de transcripci√≥n no est√° disponible');
      }
    }
    
    // Funci√≥n para copiar contenido al portapapeles
    async function copiarContenido() {
      const contenido = document.getElementById('editable2').innerText;
      const copyBtn = document.getElementById('copyBtn');
      
      if (!contenido || contenido.trim() === '') {
        alert('No hay contenido para copiar');
        return;
      }
      
      try {
        // Intentar usar la API moderna del portapapeles
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(contenido);
        } else {
          // Fallback para navegadores m√°s antiguos
          const textArea = document.createElement('textarea');
          textArea.value = contenido;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
        }
        
        // Mostrar feedback visual
        copyBtn.classList.add('copied');
        copyBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20,6 9,17 4,12"></polyline>
          </svg>
        `;
        
        // Mostrar mensaje de √©xito
        mostrarMensajeExito('Contenido copiado al portapapeles');
        
        // Restaurar el bot√≥n despu√©s de 2 segundos
        setTimeout(() => {
          copyBtn.classList.remove('copied');
          copyBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          `;
        }, 2000);
        
      } catch (error) {
        console.error('Error al copiar:', error);
        alert('Error al copiar el contenido: ' + error.message);
      }
    }
    
    // Funci√≥n para limpiar y recrear usuario de prueba (para debugging)
    function limpiarYRecrearUsuarioTest() {
      // Limpiar usuarios existentes
      localStorage.removeItem('usuarios');
      localStorage.removeItem('usuarioActual');
      
      // Recrear usuario de prueba
      const usuarioTest = {
        id: 1,
        nombre: 'Usuario Test',
        email: 'test',
        password: 'test',
        fechaCreacion: new Date().toISOString()
      };
      
      usuarios = [usuarioTest];
      localStorage.setItem('usuarios', JSON.stringify(usuarios));
      console.log('üîÑ Usuario de prueba recreado: test / test');
    }
    
    // Ejecutar limpieza al cargar la p√°gina (solo para debugging)
    // limpiarYRecrearUsuarioTest(); // Descomenta esta l√≠nea si necesitas resetear el usuario
    
    // Funci√≥n para mostrar/ocultar el dropdown de plantillas
    function toggleTemplatesDropdown() {
      const dropdown = document.getElementById('templatesDropdown');
      const isVisible = dropdown.style.display !== 'none';
      
      if (isVisible) {
        dropdown.style.display = 'none';
      } else {
        dropdown.style.display = 'block';
      }
    }
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('templatesDropdown');
      const templatesBtn = document.querySelector('.templates-btn-panel');
      
      if (!templatesBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
    
    // Event listener para el bot√≥n TRANSCRIBIR
    document.getElementById('transcribirBtn').addEventListener('click', function() {
      document.getElementById('audioFileInput').click();
    });
    
    // Funci√≥n para transcribir audio
    async function transcribirAudio() {
      const fileInput = document.getElementById('audioFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Por favor selecciona un archivo de audio');
        return;
      }
      
      // Verificar tipo de archivo
      const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/aac', 'audio/ogg'];
      if (!allowedTypes.includes(file.type)) {
        alert('Tipo de archivo no soportado. Usa MP3, WAV, M4A, AAC u OGG');
        return;
      }
      
      // Verificar tama√±o (25MB m√°ximo)
      if (file.size > 25 * 1024 * 1024) {
        alert('El archivo es demasiado grande. El l√≠mite es 25MB');
        return;
      }
      
      // Mostrar indicador de carga
      const transcribirBtn = document.getElementById('transcribirBtn');
      const originalText = transcribirBtn.textContent;
      transcribirBtn.textContent = 'TRANSCRIBIENDO...';
      transcribirBtn.disabled = true;
      
      try {
        // Crear FormData para enviar el archivo
        const formData = new FormData();
        formData.append('file', file);
        
        // Realizar petici√≥n al servidor
        const response = await fetch('/api/transcribir', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Agregar la transcripci√≥n al panel izquierdo
          const editable1 = document.getElementById('editable1');
          const transcripcion = result.transcripcion;
          
          // Si ya hay contenido, agregar un salto de l√≠nea
          if (editable1.innerHTML.trim()) {
            editable1.innerHTML += '<br><br>';
          }
          
          editable1.innerHTML += `<strong>Transcripci√≥n:</strong><br>${transcripcion}`;
          
          // Mostrar mensaje de √©xito
          alert(`Transcripci√≥n completada exitosamente!\n\nArchivo: ${result.archivo}\nCaracteres: ${transcripcion.length}`);
        } else {
          alert('Error en la transcripci√≥n: ' + result.error);
        }
        
      } catch (error) {
        console.error('Error al transcribir:', error);
        alert('Error al transcribir el audio: ' + error.message);
      } finally {
        // Restaurar bot√≥n
        transcribirBtn.textContent = originalText;
        transcribirBtn.disabled = false;
        
        // Limpiar input
        fileInput.value = '';
      }
    }
  </script>
  <script src="transcripcion_integration.js"></script>
</body>
</html> 